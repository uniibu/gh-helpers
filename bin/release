#!/usr/bin/env node

const exec = require('../lib/exec');
const processor = require('../lib/processor');
const args = processor.parse(process.argv);

const releaseVer = args[0];
const publish = args[1];
const origin = 'origin'
let branch = exec.execa.shellSync('git branch', { encoding: 'utf8' })
branch = branch.stdout.replace(/^(\* )/g, '').replace('\n', '');

async function release() {
  let releaseArgs = `${releaseVer} ` + '--git.commit --non-interactive --git.commitArgs="-S" --git.push --git.tag --git.tagName="v${version}" --github.release --git.tagArgs="-s"'
  if (publish && publish == '--publish') {
    releaseArgs += ' --npm.publish'
  } else {
    releaseArgs += ' --no-npm.publish'
  }
  await exec(`${processor.npm} release-it ${releaseArgs}`, true);
}


exec(`bin/pull ${origin} ${branch}`)
  .then(() => release())
  .then(process.exit);